name: Deploy to GitHub Pages

on:
  # 每次推送到 `main` 分支时触发这个“工作流程”
  # 如果你使用了别的分支名，请按需将 `main` 替换成你的分支名
  push:
    branches: [ main ]
  # 允许你在 GitHub 上的 Actions 标签中手动触发此“工作流程”
  workflow_dispatch:

# 允许 job 克隆 repo 并创建一个 page deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository using git
        uses: actions/checkout@v5
      - name: Install, build, and upload your site
        uses: withastro/action@v5
        with:
          # path: . # 存储库中 Astro 项目的根位置。（可选）
          # node-version: 20 # 用于构建站点的特定 Node.js 版本，默认为 20。（可选）
          # package-manager: pnpm@latest # 应使用哪个 Node.js 包管理器来安装依赖项和构建站点。会根据存储库中的 lockfile 自动检测。（可选）
          build-cmd: pnpm run build # 用于构建你的网站的命令。默认运行软件包的构建脚本或任务。（可选）
        # env:
          # PUBLIC_POKEAPI: 'https://pokeapi.co/api/v2' # 对变量值使用单引号。（可选）
      - name: Verify dist directory exists
        run: |
          if [ ! -d "dist" ]; then
            echo "错误：构建后未找到 dist 目录（Astro 默认输出目录）"
            exit 1
          fi
          echo "✓ dist 目录已生成"
          du -sh dist/

      # ==========================================
      # 分支 B: 同步到 腾讯云服务器（在 build job 里做，避免跨 job 传 dist）
      # ==========================================
      - name: 启用 SSH Agent（注入私钥）
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: 写入 known_hosts（避免首次连接交互）
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          set -e
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          PORT="${REMOTE_PORT:-22}"
          ssh-keyscan -p "$PORT" -H "$REMOTE_HOST" >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: 测试 SSH 登录（用于定位 publickey 失败原因）
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
        run: |
          set -e
          PORT="${REMOTE_PORT:-22}"
          ssh -o StrictHostKeyChecking=yes -p "$PORT" "${REMOTE_USER}@${REMOTE_HOST}" "echo 'SSH 登录成功'; whoami; hostname; pwd"

      - name: Rsync 同步 dist 到服务器
        env:
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          REMOTE_PORT: ${{ secrets.REMOTE_PORT }}
          TARGET: "/opt/1panel/apps/openresty/openresty/www/sites/qingswe.com/blog/index/"
        run: |
          set -e
          PORT="${REMOTE_PORT:-22}"
          # 先确保目标目录存在，并验证是否有写权限（便于快速定位权限问题）
          ssh -p "${PORT}" -o StrictHostKeyChecking=yes "${REMOTE_USER}@${REMOTE_HOST}" "mkdir -p '${TARGET}' && test -w '${TARGET}' && echo '目标目录可写' || (echo '目标目录不可写（请检查目录属主/权限）' && exit 1)"
          rsync -rtvz --delete -e "ssh -p ${PORT} -o StrictHostKeyChecking=yes" dist/ "${REMOTE_USER}@${REMOTE_HOST}:${TARGET}"

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # 分支 A: 部署到 GitHub Pages
      # 说明：withastro/action@v5 已在 build job 中负责上传 Pages artifact，
      # 这里不要再重复 upload-pages-artifact，否则会触发 409（同名 artifact 已存在）
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4